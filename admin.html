<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5K Digital Studio - Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Add CKEditor script -->
    <script src="https://cdn.ckeditor.com/ckeditor5/41.1.0/classic/ckeditor.js"></script>
    <style>
        :root {
            --primary: #6e48aa;
            --primary-dark: #5d3a99;
            --secondary: #f5f7fa;
            --dark: #2a2a2a;
            --light: #ffffff;
            --gray: #dddddd;
            --dark-gray: #888888;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            min-height: 100vh;
        }

        /* Login Page Styles */
        .login-container {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .login-container h1 {
            color: #6e48aa;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .login-btn {
            width: 100%;
            padding: 0.75rem;
            background: #6e48aa;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .login-btn:hover {
            background: #5d3a99;
        }
        
        .error-message {
            color: #dc3545;
            margin-top: 1rem;
            text-align: center;
        }

        /* Admin Dashboard Styles */
        .admin-container {
            display: none;
            min-height: 100vh;
        }
        
        body.admin-authenticated {
            background-color: #f8f9fa;
        }
        
        body.admin-authenticated .login-container {
            display: none;
        }
        
        body.admin-authenticated .admin-container {
            display: flex;
        }

        /* Admin Layout */
        .sidebar {
            width: 250px;
            background: var(--dark);
            color: white;
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            transition: all 0.3s;
        }
        
        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-menu {
            padding: 20px 0;
        }
        
        .sidebar-menu h3 {
            color: var(--gray);
            font-size: 14px;
            padding: 0 20px 10px;
            text-transform: uppercase;
        }
        
        .sidebar-menu ul {
            list-style: none;
        }
        
        .sidebar-menu li a {
            display: block;
            padding: 12px 20px;
            color: white;
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .sidebar-menu li a:hover,
        .sidebar-menu li a.active {
            background: rgba(255, 255, 255, 0.1);
            border-left: 3px solid var(--primary);
        }
        
        .sidebar-menu li a i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        /* Main Content */
        .main-content {
            margin-left: 250px;
            width: calc(100% - 250px);
            padding: 20px;
        }
        
        /* Top Navigation */
        .top-nav {
            background: white;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }
        
        .user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        /* Admin Cards */
        .admin-card {
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .admin-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gray);
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--gray);
            border-radius: 4px;
            font-size: 16px;
        }
        
        textarea.form-control {
            min-height: 150px;
            resize: vertical;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        /* Tables */
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th, .table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--gray);
        }
        
        .table th {
            background: var(--secondary);
            font-weight: 600;
        }
        
        .table tr:hover {
            background: rgba(110, 72, 170, 0.05);
        }
        
        .action-btns a {
            color: var(--primary);
            margin-right: 10px;
            cursor: pointer;
        }
        
        .action-btns a.delete {
            color: #dc3545;
        }

        /* Image Upload Styles */
        .image-upload-container {
            margin-bottom: 20px;
        }

        .image-preview {
            width: 150px;
            height: 150px;
            border: 1px dashed #ddd;
            border-radius: 4px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background-color: #f9f9f9;
        }

        .image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .image-preview span {
            color: #999;
            font-size: 14px;
        }

        .upload-btn {
            display: inline-block;
            padding: 8px 15px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-btn:hover {
            background: #e0e0e0;
        }

        .table-img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
        }
        
        /* CKEditor Styles */
        .ck-editor__editable {
            min-height: 200px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 80px;
                overflow: hidden;
            }
            
            .sidebar-header h2, 
            .sidebar-menu h3,
            .sidebar-menu li a span {
                display: none;
            }
            
            .sidebar-menu li a {
                text-align: center;
                padding: 15px 10px;
            }
            
            .sidebar-menu li a i {
                margin-right: 0;
                font-size: 20px;
            }
            
            .main-content {
                margin-left: 80px;
                width: calc(100% - 80px);
            }
        }
    </style>
</head>
<body>
    <!-- Login Section -->
    <div class="login-container" id="login-container">
        <h1>Admin Login</h1>
        <form id="login-form">
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" required>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" required>
            </div>
            <button type="submit" class="login-btn">Login</button>
            <div id="error-message" class="error-message"></div>
        </form>
    </div>

    <!-- Admin Dashboard Section -->
    <div class="admin-container" id="admin-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>5K Digital Studio</h2>
            </div>
            
            <div class="sidebar-menu">
                <h3>Main</h3>
                <ul>
                    <li><a href="#dashboard" class="active"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a></li>
                </ul>
                
                <h3>Content</h3>
                <ul>
                    <li><a href="#products"><i class="fas fa-box-open"></i> <span>Products</span></a></li>
                    <li><a href="#blog"><i class="fas fa-blog"></i> <span>Blog Posts</span></a></li>
                    <li><a href="#faq"><i class="fas fa-question-circle"></i> <span>FAQs</span></a></li>
                    <!-- Removed Messages Link -->
                </ul>
            </div>
        </div>
        
        <div class="main-content">
            <div class="top-nav">
                <h3>Admin Dashboard</h3>
                <div class="user-info">
                    <img src="https://via.placeholder.com/40" alt="Admin User" id="user-avatar">
                    <span id="user-email"></span>
                    <button id="logout-btn" class="btn btn-danger" style="margin-left: 15px;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
            
            <div id="dashboard" class="admin-section">
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h4>Quick Stats</h4>
                    </div>
                    <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div class="stat-card">
                            <h5>Total Products</h5>
                            <p id="total-products">0</p>
                        </div>
                        <div class="stat-card">
                            <h5>Total Blog Posts</h5>
                            <p id="total-blogs">0</p>
                        </div>
                        <div class="stat-card">
                            <h5>Total FAQs</h5>
                            <p id="total-faqs">0</p>
                        </div>
                        <!-- Removed Total Messages Stat -->
                    </div>
                </div>
            </div>
            
            <div id="products" class="admin-section" style="display: none;">
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h4>Manage Products</h4>
                        <button class="btn btn-primary" id="add-product-btn">
                            <i class="fas fa-plus"></i> Add Product
                        </button>
                    </div>
                    
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Title</th>
                                <th>Type</th>
                                <th>Downloads</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="products-table"></tbody>
                    </table>
                </div>
                
                <div class="admin-card" id="product-form-container" style="display: none;">
                    <div class="admin-card-header">
                        <h4 id="product-form-title">Add New Product</h4>
                        <button class="btn btn-danger" id="cancel-product-btn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                    
                    <form id="product-form">
                        <input type="hidden" id="product-id">
                        <div class="form-group">
                            <label for="product-title">Product Title</label>
                            <input type="text" id="product-title" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="product-description">Description</label>
                            <!-- Removed 'required' attribute from here -->
                            <textarea id="product-description" class="form-control" style="display: none;"></textarea>
                            <div id="product-description-editor"></div>
                        </div>
                        <div class="form-group">
                            <label for="product-type">Type</label>
                            <select id="product-type" class="form-control" required>
                                <option value="">Select Type</option>
                                <option value="course">Course</option>
                                <option value="template">Template</option>
                                <option value="preset">Preset</option>
                                <option value="ebook">Ebook</option>
                                <option value="3d-model">3D Model</option>
                                <option value="font">Font</option>
                                <option value="texture">Texture</option>
                                <option value="ui-kit">UI Kit</option>
                                <option value="audio">Audio</option>
                                <option value="brush">Brush</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="product-icon">Icon Class (Font Awesome)</label>
                            <input type="text" id="product-icon" class="form-control" value="fas fa-file" required>
                        </div>
                        <div class="form-group">
                            <label for="product-downloads">Downloads</label>
                            <input type="number" id="product-downloads" class="form-control" value="0" required>
                        </div>
                        
                        <div class="form-group image-upload-container">
                            <label for="product-image-upload">Product Image</label>
                            <input type="file" id="product-image-upload" accept="image/*" style="display: none;">
                            <button type="button" class="upload-btn" onclick="document.getElementById('product-image-upload').click()">
                                <i class="fas fa-upload"></i> Choose Image
                            </button>
                            <div class="image-preview" id="image-preview">
                                <span>No image selected</span>
                            </div>
                            <input type="hidden" id="product-image-url">
                        </div>
                        
                        <div class="form-group">
                            <label for="product-download-link">Download Link (Optional)</label>
                            <input type="url" id="product-download-link" class="form-control" placeholder="https://example.com/download">
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Save Product</button>
                    </form>
                </div>
            </div>
            
            <div id="blog" class="admin-section" style="display: none;">
                 <div class="admin-card">
                    <div class="admin-card-header">
                        <h4>Manage Blog Posts</h4>
                        <button class="btn btn-primary" id="add-blog-btn">
                            <i class="fas fa-plus"></i> Add Blog Post
                        </button>
                    </div>
                    
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="blog-table"></tbody>
                    </table>
                </div>
                
                <div class="admin-card" id="blog-form-container" style="display: none;">
                    <div class="admin-card-header">
                        <h4 id="blog-form-title">Add New Blog Post</h4>
                        <button class="btn btn-danger" id="cancel-blog-btn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                    
                    <form id="blog-form">
                        <input type="hidden" id="blog-id">
                        <div class="form-group">
                            <label for="blog-title">Title</label>
                            <input type="text" id="blog-title" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="blog-date">Date</label>
                            <input type="date" id="blog-date" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="blog-excerpt">Excerpt</label>
                            <!-- Removed 'required' attribute from here -->
                            <textarea id="blog-excerpt" class="form-control" style="display: none;"></textarea>
                            <div id="blog-excerpt-editor"></div>
                        </div>
                        <div class="form-group">
                            <label for="blog-content">Content</label>
                            <!-- Removed 'required' attribute from here -->
                            <textarea id="blog-content" class="form-control" rows="10" style="display: none;"></textarea>
                            <div id="blog-content-editor"></div>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Blog Post</button>
                    </form>
                </div>
            </div>
            
            <div id="faq" class="admin-section" style="display: none;">
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h4>Manage FAQs</h4>
                        <button class="btn btn-primary" id="add-faq-btn">
                            <i class="fas fa-plus"></i> Add FAQ
                        </button>
                    </div>
                    
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Question</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="faq-table"></tbody>
                    </table>
                </div>
                
                <div class="admin-card" id="faq-form-container" style="display: none;">
                    <div class="admin-card-header">
                        <h4 id="faq-form-title">Add New FAQ</h4>
                        <button class="btn btn-danger" id="cancel-faq-btn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                    
                    <form id="faq-form">
                        <input type="hidden" id="faq-id">
                        <div class="form-group">
                            <label for="faq-question">Question</label>
                            <input type="text" id="faq-question" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="faq-answer">Answer</label>
                            <textarea id="faq-answer" class="form-control" rows="5" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Save FAQ</button>
                    </form>
                </div>
            </div>

            <!-- Removed Messages Section -->

        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBJa8xvmu19M-tokkjT8Y4R9diGM4FG-Go",
            authDomain: "k-digital-studio-64d0f.firebaseapp.com",
            projectId: "k-digital-studio-64d0f",
            storageBucket: "k-digital-studio-64d0f.firebasestorage.app",
            messagingSenderId: "986818037155",
            appId: "1:986818037155:web:c41803fe1f9214477c0616",
            measurementId: "G-ZJ43QR9W71"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
        const auth = firebase.auth();

        // --- GLOBAL VARIABLES ---
        let products = [];
        let blogs = [];
        let faqs = [];
        // Removed messages global variable
        let currentProductFile = null;
        let productDescriptionEditor = null;
        let blogExcerptEditor = null; // New CKEditor instance for blog excerpt
        let blogContentEditor = null; // New CKEditor instance for blog content


        // --- DOM Elements ---
        const loginContainer = document.getElementById('login-container');
        const adminContainer = document.getElementById('admin-container');
        const loginForm = document.getElementById('login-form');
        const errorMessage = document.getElementById('error-message');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmail = document.getElementById('user-email');
        const adminSections = document.querySelectorAll('.admin-section');
        const sidebarLinks = document.querySelectorAll('.sidebar-menu a');
        
        // Product elements
        const productsTable = document.getElementById('products-table');
        const productFormContainer = document.getElementById('product-form-container');
        const productForm = document.getElementById('product-form');
        const productFormTitle = document.getElementById('product-form-title');
        const addProductBtn = document.getElementById('add-product-btn');
        const cancelProductBtn = document.getElementById('cancel-product-btn');
        const imageUpload = document.getElementById('product-image-upload');
        const imagePreview = document.getElementById('image-preview');
        const imageUrlInput = document.getElementById('product-image-url');
        
        // Blog elements
        const blogTable = document.getElementById('blog-table');
        const blogFormContainer = document.getElementById('blog-form-container');
        const blogForm = document.getElementById('blog-form');
        const blogFormTitle = document.getElementById('blog-form-title');
        const addBlogBtn = document.getElementById('add-blog-btn');
        const cancelBlogBtn = document.getElementById('cancel-blog-btn');
        
        // FAQ elements
        const faqTable = document.getElementById('faq-table');
        const faqFormContainer = document.getElementById('faq-form-container');
        const faqForm = document.getElementById('faq-form');
        const faqFormTitle = document.getElementById('faq-form-title');
        const addFaqBtn = document.getElementById('add-faq-btn');
        const cancelFaqBtn = document.getElementById('cancel-faq-btn');

        // Removed Messages elements
        // const messagesTable = document.getElementById('messages-table'); 


        // --- AUTHENTICATION HANDLING ---
        auth.onAuthStateChanged((user) => {
            if (user) {
                // User is signed in
                document.body.classList.add('admin-authenticated');
                userEmail.textContent = user.email;
                
                // Initialize admin dashboard
                initAdminDashboard();
            } else {
                // No user is signed in
                document.body.classList.remove('admin-authenticated');
            }
        });

        // Login form handler
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                await auth.signInWithEmailAndPassword(email, password);
                errorMessage.textContent = '';
            } catch (error) {
                errorMessage.textContent = error.message;
            }
        });

        // Logout handler
        logoutBtn.addEventListener('click', () => {
            auth.signOut().then(() => {
                window.location.reload();
            });
        });

        // --- ADMIN DASHBOARD FUNCTIONS ---
        function initAdminDashboard() {
            setupEventListeners();
            showSection('dashboard');
            fetchInitialData();
            initCKEditors(); // Renamed to initCKEditors to handle multiple instances
        }

        // Renamed and modified to initialize all CKEditor instances
        function initCKEditors() {
            // Product Description Editor
            ClassicEditor
                .create(document.querySelector('#product-description-editor'), {
                    toolbar: [
                        'heading', '|',
                        'bold', 'italic', 'underline', 'link', '|',
                        'bulletedList', 'numberedList', '|',
                        'undo', 'redo'
                    ]
                })
                .then(editor => {
                    productDescriptionEditor = editor;
                    // No need for a submit listener here, will sync in handleProductSubmit directly
                })
                .catch(error => {
                    console.error('Error initializing product description CKEditor:', error);
                });

            // Blog Excerpt Editor
            ClassicEditor
                .create(document.querySelector('#blog-excerpt'), { // Target the textarea directly
                    toolbar: [
                        'bold', 'italic', 'underline', 'link', '|',
                        'undo', 'redo'
                    ]
                })
                .then(editor => {
                    blogExcerptEditor = editor;
                })
                .catch(error => {
                    console.error('Error initializing blog excerpt CKEditor:', error);
                });

            // Blog Content Editor
            ClassicEditor
                .create(document.querySelector('#blog-content'), { // Target the textarea directly
                    toolbar: [
                        'heading', '|',
                        'bold', 'italic', 'underline', 'link', '|',
                        'bulletedList', 'numberedList', 'blockQuote', '|',
                        'undo', 'redo'
                    ]
                })
                .then(editor => {
                    blogContentEditor = editor;
                })
                .catch(error => {
                    console.error('Error initializing blog content CKEditor:', error);
                });
        }


        async function fetchInitialData() {
            await Promise.all([
                fetchAndRenderProducts(),
                fetchAndRenderBlogs(),
                fetchAndRenderFaqs(),
                // Removed fetchAndRenderMessages()
            ]);
            updateStats();
        }

        function setupEventListeners() {
            // Sidebar navigation
            sidebarLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const sectionId = this.getAttribute('href').substring(1);
                    showSection(sectionId);
                    sidebarLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    // Removed re-fetch for messages section
                });
            });
            
            // Product management
            addProductBtn.addEventListener('click', () => showProductForm());
            cancelProductBtn.addEventListener('click', () => hideProductForm());
            productForm.addEventListener('submit', handleProductSubmit); // This is correct
            imageUpload.addEventListener('change', handleImagePreview);
            
            // Blog management
            addBlogBtn.addEventListener('click', () => showBlogForm());
            cancelBlogBtn.addEventListener('click', () => hideBlogForm());
            blogForm.addEventListener('submit', handleBlogSubmit);
            
            // FAQ management
            addFaqBtn.addEventListener('click', () => showFaqForm());
            cancelFaqBtn.addEventListener('click', () => hideFaqForm());
            faqForm.addEventListener('submit', handleFaqSubmit);
        }
        
        function showSection(sectionId) {
            adminSections.forEach(section => { section.style.display = 'none'; });
            document.getElementById(sectionId).style.display = 'block';
        }
        
        function updateStats() {
            document.getElementById('total-products').textContent = products.length;
            document.getElementById('total-blogs').textContent = blogs.length;
            document.getElementById('total-faqs').textContent = faqs.length;
            // Removed messages count update
        }

        // --- HELPER FUNCTIONS ---
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }
        
        /* ======================================== */
        /* PRODUCT MANAGEMENT              */
        /* ======================================== */
        
        async function fetchAndRenderProducts() {
            try {
                const snapshot = await db.collection('products').get();
                products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProducts();
            } catch (error) {
                console.error("Error fetching products:", error);
                alert("Error fetching products. Please check console for details.");
            }
        }

        function renderProducts() {
            productsTable.innerHTML = '';
            if (products.length === 0) {
                productsTable.innerHTML = '<tr><td colspan="5">No products found.</td></tr>';
                return;
            }
            products.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><img src="${product.image || 'https://via.placeholder.com/60'}" class="table-img" alt="${product.title}"></td>
                    <td>${product.title}</td>
                    <td>${product.type}</td>
                    <td>${product.downloads}</td>
                    <td class="action-btns">
                        <a class="edit-product" data-id="${product.id}"><i class="fas fa-edit"></i></a>
                        <a class="delete-product" data-id="${product.id}"><i class="fas fa-trash"></i></a>
                    </td>
                `;
                productsTable.appendChild(row);
            });
            
            document.querySelectorAll('.edit-product').forEach(btn => btn.addEventListener('click', (e) => editProduct(e.currentTarget.getAttribute('data-id'))));
            document.querySelectorAll('.delete-product').forEach(btn => btn.addEventListener('click', (e) => deleteProduct(e.currentTarget.getAttribute('data-id'))));
        }
        
        function showProductForm(product = null) {
            productForm.reset();
            currentProductFile = null;
            document.getElementById('product-id').value = '';
            imageUrlInput.value = '';
            imagePreview.innerHTML = '<span>No image selected</span>';

            if (product) {
                productFormTitle.textContent = 'Edit Product';
                document.getElementById('product-id').value = product.id;
                document.getElementById('product-title').value = product.title;
                // Set CKEditor data if instance exists
                if (productDescriptionEditor) {
                    productDescriptionEditor.setData(product.description || ''); // Use || '' to handle undefined
                }
                document.getElementById('product-type').value = product.type;
                document.getElementById('product-icon').value = product.icon;
                document.getElementById('product-downloads').value = product.downloads;
                document.getElementById('product-download-link').value = product.downloadLink || '';
                
                if (product.image) {
                    imagePreview.innerHTML = `<img src="${product.image}" alt="Preview">`;
                    imageUrlInput.value = product.image;
                }
            } else {
                productFormTitle.textContent = 'Add New Product';
                // Clear CKEditor data if instance exists
                if (productDescriptionEditor) {
                    productDescriptionEditor.setData('');
                }
            }
            productFormContainer.style.display = 'block';
        }

        function hideProductForm() { productFormContainer.style.display = 'none'; }
        
        function handleImagePreview(e) {
            const file = e.target.files[0];
            if (file) {
                currentProductFile = file;
                const reader = new FileReader();
                reader.onload = (event) => {
                    imagePreview.innerHTML = `<img src="${event.target.result}" alt="Preview">`;
                };
                reader.readAsDataURL(file);
            } else {
                imagePreview.innerHTML = '<span>No image selected</span>';
            }
        }

        async function handleProductSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('product-id').value;
            let imageUrl = imageUrlInput.value;

            try {
                // Ensure CKEditor content is synced before submission
                const description = productDescriptionEditor ? productDescriptionEditor.getData() : ''; // Get data, default to empty string if editor not ready or empty

                // Basic validation for CKEditor content
                if (productDescriptionEditor && description.trim() === '') {
                    alert('Product description cannot be empty.');
                    return; // Stop submission
                }

                // Upload image if a new one is selected
                if (currentProductFile) {
                    const filePath = `product_images/${Date.now()}_${currentProductFile.name}`;
                    const fileRef = storage.ref(filePath);
                    await fileRef.put(currentProductFile);
                    imageUrl = await fileRef.getDownloadURL();
                }

                const productData = {
                    title: document.getElementById('product-title').value,
                    description: description, // Use the synced description
                    type: document.getElementById('product-type').value,
                    icon: document.getElementById('product-icon').value,
                    downloads: parseInt(document.getElementById('product-downloads').value) || 0,
                    image: imageUrl || 'https://via.placeholder.com/150',
                    downloadLink: document.getElementById('product-download-link').value || '',
                    createdAt: id ? firebase.firestore.FieldValue.serverTimestamp() : firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (id) {
                    await db.collection('products').doc(id).update(productData);
                } else {
                    await db.collection('products').add(productData);
                }
                
                await fetchAndRenderProducts();
                updateStats();
                hideProductForm();
            } catch (error) {
                console.error("Error saving product:", error);
                alert("Error saving product. Please check console for details.");
            }
        }

        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (product) showProductForm(product);
        }
        
        async function deleteProduct(id) {
            if (confirm('Are you sure you want to delete this product?')) {
                try {
                    // Find the product to get its image URL for deletion from storage
                    const productToDelete = products.find(p => p.id === id);
                    if (productToDelete && productToDelete.image && productToDelete.image.startsWith('gs://')) { // Check if it's a storage URL
                        const imageRef = storage.refFromURL(productToDelete.image);
                        await imageRef.delete().catch(error => {
                            // Ignore if file doesn't exist, log other errors
                            if (error.code !== 'storage/object-not-found') {
                                console.error("Error deleting image from storage:", error);
                            }
                        });
                    }
                    await db.collection('products').doc(id).delete();
                    await fetchAndRenderProducts();
                    updateStats();
                } catch (error) {
                    console.error("Error deleting product:", error);
                    alert("Error deleting product. Please check console for details.");
                }
            }
        }

        /* ======================================== */
        /* BLOG MANAGEMENT                */
        /* ======================================== */

        async function fetchAndRenderBlogs() {
            try {
                const snapshot = await db.collection('blogs').orderBy('date', 'desc').get();
                blogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderBlogs();
            } catch (error) {
                console.error("Error fetching blogs:", error);
                alert("Error fetching blogs. Please check console for details.");
            }
        }
        
        function renderBlogs() {
            blogTable.innerHTML = '';
            if (blogs.length === 0) {
                blogTable.innerHTML = '<tr><td colspan="3">No blog posts found.</td></tr>';
                return;
            }
            blogs.forEach(blog => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${blog.title}</td>
                    <td>${formatDate(blog.date)}</td>
                    <td class="action-btns">
                        <a class="edit-blog" data-id="${blog.id}"><i class="fas fa-edit"></i></a>
                        <a class="delete-blog" data-id="${blog.id}"><i class="fas fa-trash"></i></a>
                    </td>
                `;
                blogTable.appendChild(row);
            });

            document.querySelectorAll('.edit-blog').forEach(btn => btn.addEventListener('click', (e) => editBlog(e.currentTarget.getAttribute('data-id'))));
            document.querySelectorAll('.delete-blog').forEach(btn => btn.addEventListener('click', (e) => deleteBlog(e.currentTarget.getAttribute('data-id'))));
        }

        function showBlogForm(blog = null) {
            blogForm.reset();
            document.getElementById('blog-id').value = '';
            
            if (blog) {
                blogFormTitle.textContent = 'Edit Blog Post';
                document.getElementById('blog-id').value = blog.id;
                document.getElementById('blog-title').value = blog.title;
                document.getElementById('blog-date').value = blog.date;
                // Set CKEditor data for blog excerpt and content
                if (blogExcerptEditor) {
                    blogExcerptEditor.setData(blog.excerpt || '');
                }
                if (blogContentEditor) {
                    blogContentEditor.setData(blog.content || '');
                }
            } else {
                blogFormTitle.textContent = 'Add New Blog Post';
                document.getElementById('blog-date').value = new Date().toISOString().split('T')[0];
                // Clear CKEditor data for blog excerpt and content
                if (blogExcerptEditor) {
                    blogExcerptEditor.setData('');
                }
                if (blogContentEditor) {
                    blogContentEditor.setData('');
                }
            }
            blogFormContainer.style.display = 'block';
        }

        function hideBlogForm() { blogFormContainer.style.display = 'none'; }
        
        async function handleBlogSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('blog-id').value;
            
            try {
                // Get data from CKEditor instances before submission
                const excerpt = blogExcerptEditor ? blogExcerptEditor.getData() : ''; // Default to empty string
                const content = blogContentEditor ? blogContentEditor.getData() : ''; // Default to empty string

                // Basic validation for CKEditor content
                if (blogExcerptEditor && excerpt.trim() === '') {
                    alert('Blog excerpt cannot be empty.');
                    return;
                }
                if (blogContentEditor && content.trim() === '') {
                    alert('Blog content cannot be empty.');
                    return;
                }

                const blogData = {
                    title: document.getElementById('blog-title').value,
                    date: document.getElementById('blog-date').value,
                    excerpt: excerpt, // Use synced excerpt
                    content: content, // Use synced content
                    createdAt: id ? firebase.firestore.FieldValue.serverTimestamp() : firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (id) {
                    await db.collection('blogs').doc(id).update(blogData);
                } else {
                    await db.collection('blogs').add(blogData);
                }
                
                await fetchAndRenderBlogs();
                updateStats();
                hideBlogForm();
            } catch (error) {
                console.error("Error saving blog post:", error);
                alert("Error saving blog post. Please check console for details.");
            }
        }

        function editBlog(id) {
            const blog = blogs.find(b => b.id === id);
            if (blog) showBlogForm(blog);
        }
        
        async function deleteBlog(id) {
            if (confirm('Are you sure you want to delete this blog post?')) {
                try {
                    await db.collection('blogs').doc(id).delete();
                    await fetchAndRenderBlogs();
                    updateStats();
                } catch (error) {
                    console.error("Error deleting blog post:", error);
                    alert("Error deleting blog post. Please check console for details.");
                }
            }
        }
        
        /* ======================================== */
        /* FAQ MANAGEMENT                */
        /* ======================================== */
        
        async function fetchAndRenderFaqs() {
            try {
                const snapshot = await db.collection('faqs').get();
                faqs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderFaqs();
            } catch (error) {
                console.error("Error fetching FAQs:", error);
                alert("Error fetching FAQs. Please check console for details.");
            }
        }

        function renderFaqs() {
            faqTable.innerHTML = '';
            if (faqs.length === 0) {
                faqTable.innerHTML = '<tr><td colspan="2">No FAQs found.</td></tr>';
                return;
            }
            faqs.forEach(faq => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${faq.question}</td>
                    <td class="action-btns">
                        <a class="edit-faq" data-id="${faq.id}"><i class="fas fa-edit"></i></a>
                        <a class="delete-faq" data-id="${faq.id}"><i class="fas fa-trash"></i></a>
                    </td>
                `;
                faqTable.appendChild(row);
            });

            document.querySelectorAll('.edit-faq').forEach(btn => btn.addEventListener('click', (e) => editFaq(e.currentTarget.getAttribute('data-id'))));
            document.querySelectorAll('.delete-faq').forEach(btn => btn.addEventListener('click', (e) => deleteFaq(e.currentTarget.getAttribute('data-id'))));
        }

        function showFaqForm(faq = null) {
            faqForm.reset();
            document.getElementById('faq-id').value = '';

            if (faq) {
                faqFormTitle.textContent = 'Edit FAQ';
                document.getElementById('faq-id').value = faq.id;
                document.getElementById('faq-question').value = faq.question;
                document.getElementById('faq-answer').value = faq.answer;
            } else {
                faqFormTitle.textContent = 'Add New FAQ';
            }
            faqFormContainer.style.display = 'block';
        }

        function hideFaqForm() { faqFormContainer.style.display = 'none'; }
        
        async function handleFaqSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('faq-id').value;
            
            try {
                const faqData = {
                    question: document.getElementById('faq-question').value,
                    answer: document.getElementById('faq-answer').value,
                    createdAt: id ? firebase.firestore.FieldValue.serverTimestamp() : firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (id) {
                    await db.collection('faqs').doc(id).update(faqData);
                } else {
                    await db.collection('faqs').add(faqData);
                }
                
                await fetchAndRenderFaqs();
                updateStats();
                hideFaqForm();
            } catch (error) {
                console.error("Error saving FAQ:", error);
                alert("Error saving FAQ. Please check console for details.");
            }
        }

        function editFaq(id) {
            const faq = faqs.find(f => f.id === id);
            if (faq) showFaqForm(faq);
        }
        
        async function deleteFaq(id) {
            if (confirm('Are you sure you want to delete this FAQ?')) {
                try {
                    await db.collection('faqs').doc(id).delete();
                    await fetchAndRenderFaqs();
                    updateStats();
                } catch (error) {
                    console.error("Error deleting FAQ:", error);
                    alert("Error deleting FAQ. Please check console for details.");
                }
            }
        }

        /* Removed Message Management Section */
    </script>
</body>
</html>
